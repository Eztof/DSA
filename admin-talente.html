<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Talente verwalten</title>
</head>
<body>
  <h1>Talente</h1>

  <h2>Neues Talent hinzufÃ¼gen</h2>
  <input id="name" placeholder="Name"><br>

  <label>Gruppe:</label>
  <select id="gruppe">
    <option>Kampftalente</option>
    <option>KÃ¶rperliche Talente</option>
    <option>Gesellschaftliche Talente</option>
    <option>Natur-Talente</option>
    <option>Wissenstalente</option>
    <option>Sprachen/Schriften</option>
    <option>Handwerkstalente</option>
  </select><br>

  <div id="eigenschafts-container">
    <label>Eigenschaft 1:</label>
    <select id="eigenschaft1"></select>
    <label>Eigenschaft 2:</label>
    <select id="eigenschaft2"></select>
    <label>Eigenschaft 3:</label>
    <select id="eigenschaft3"></select><br>
  </div>

  <div id="kategorie-container" style="display: none;">
    <label>Kategorie:</label>
    <select id="kategorie">
      <option>Bewaffneter Nahkampf</option>
      <option>Fernkampf</option>
      <option>Waffenlos</option>
    </select><br>
  </div>

  <label>Typ:</label>
  <select id="typ">
    <option>Basis</option>
    <option>Spezial</option>
  </select><br>

  <textarea id="voraussetzungen" placeholder="Voraussetzungen (Komma-getrennt)"></textarea><br>

  <label>eBE-Wert:</label>
  <select id="ebe">
    <option>-</option>
    <option>BE</option>
    <option>BEâ€“1</option>
    <option>BEâ€“2</option>
    <option>BEâ€“3</option>
    <option>BEâ€“4</option>
    <option>BEâ€“5</option>
    <option>x2</option>
  </select><br>

  <label>Steigern:</label>
  <select id="steigern">
    <option>A*</option>
    <option>A</option>
    <option>B</option>
    <option>C</option>
    <option>D</option>
    <option>E</option>
    <option>F</option>
    <option>G</option>
    <option>H</option>
  </select><br>

  <textarea id="ersatzweise" placeholder="Ersatzweise Talente mit Erschwernis (Komma-getrennt)"></textarea><br>

  <button onclick="hinzufuegen()">HinzufÃ¼gen</button>

  <h2>Vorhandene Talente</h2>
  <div id="liste"></div>

  <a href="admin.html">ZurÃ¼ck zum Adminbereich</a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, setDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHIftX5AvSJaPAiUIek0TBVjEtxwZo7Ow",
      authDomain: "dsapp-6722f.firebaseapp.com",
      projectId: "dsapp-6722f",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const talenteRef = collection(db, "talente");
    const eigenschaftenRef = collection(db, "eigenschaften");

    const dropdowns = ["eigenschaft1", "eigenschaft2", "eigenschaft3"];

    async function ladeEigenschaftsDropdowns() {
      const snapshot = await getDocs(eigenschaftenRef);
      const kuerzel = [];
      snapshot.forEach(doc => {
        kuerzel.push(doc.data().kuerzel);
      });

      dropdowns.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = "";
        kuerzel.forEach(k => {
          const opt = document.createElement("option");
          opt.value = k;
          opt.textContent = k;
          select.appendChild(opt);
        });
      });
    }

    document.getElementById("gruppe").addEventListener("change", () => {
      const gruppe = document.getElementById("gruppe").value;
      const isKampf = gruppe === "Kampftalente";
      document.getElementById("eigenschafts-container").style.display = isKampf ? "none" : "block";
      document.getElementById("kategorie-container").style.display = isKampf ? "block" : "none";
    });

    async function ladeTalente() {
      const container = document.getElementById("liste");
      container.innerHTML = "";

      const snapshot = await getDocs(talenteRef);
      snapshot.forEach((eintrag) => {
        const data = eintrag.data();
        const id = eintrag.id;

        const eigenschaftenText = data.gruppe === "Kampftalente"
          ? `Kategorie: ${data.kategorie}`
          : `Eigenschaften: ${data.eigenschaft1}, ${data.eigenschaft2}, ${data.eigenschaft3}`;

        const div = document.createElement("div");
        div.innerHTML = `<strong>${data.name}</strong> (${data.gruppe}) â€“ Typ: ${data.typ}<br>
          ${eigenschaftenText}<br>
          eBE: ${data.ebe}, Steigern: ${data.steigern}<br>
          Voraussetzungen: ${data.voraussetzungen?.join(", ") || "Keine"}<br>
          Ersatzweise: ${data.ersatzweise?.join(", ") || "Keine"}<br>
          <button onclick="loescheTalent('${id}')">LÃ¶schen</button><br><br>`;
        container.appendChild(div);
      });
    }

    window.hinzufuegen = async function () {
      const name = document.getElementById("name").value.trim();
      const gruppe = document.getElementById("gruppe").value;
      const isKampf = gruppe === "Kampftalente";

      let eigenschaft1 = null, eigenschaft2 = null, eigenschaft3 = null, kategorie = null;

      if (isKampf) {
        kategorie = document.getElementById("kategorie").value;
      } else {
        eigenschaft1 = document.getElementById("eigenschaft1").value;
        eigenschaft2 = document.getElementById("eigenschaft2").value;
        eigenschaft3 = document.getElementById("eigenschaft3").value;
      }

      const typ = document.getElementById("typ").value;
      const voraussetzungen = document.getElementById("voraussetzungen").value.split(",").map(s => s.trim()).filter(Boolean);
      const ebe = document.getElementById("ebe").value;
      const steigern = document.getElementById("steigern").value;
      const ersatzweise = document.getElementById("ersatzweise").value.split(",").map(s => s.trim()).filter(Boolean);

      if (!name || !ebe || !steigern || (isKampf && !kategorie) || (!isKampf && (!eigenschaft1 || !eigenschaft2 || !eigenschaft3))) {
        alert("Bitte alle Pflichtfelder ausfÃ¼llen.");
        return;
      }

      const id = name.toLowerCase().replace(/\s+/g, "-");
      await setDoc(doc(db, "talente", id), {
        name, gruppe, typ, voraussetzungen, ebe, ersatzweise, steigern,
        eigenschaft1, eigenschaft2, eigenschaft3, kategorie
      });

      document.querySelectorAll("input, textarea").forEach(el => el.value = "");
      ladeTalente();
    };

    window.loescheTalent = async function (id) {
      if (confirm(`Talent "${id}" wirklich lÃ¶schen?`)) {
        await deleteDoc(doc(db, "talente", id));
        ladeTalente();
      }
    };

    ladeEigenschaftsDropdowns().then(ladeTalente);

    async function importiereKampftalente() {
  const rohtext = `Name;Kategorie;Typ;Steigern;eBE;ersatzweise verwendbares Talent
AnderthalbhÃ¤nder;Bewaffneter Nahkampf;Spezial;E;BEâ€“2;Schwerter, Zweihandschwerter/-sÃ¤bel
Armbrust;Fernkampf;Spezial;C;BEâ€“5;Bogen
Belagerungswaffen;Fernkampf;Spezial;D;â€“;â€“
Blasrohr;Fernkampf;Spezial;D;BEâ€“5;â€“
Bogen;Fernkampf;Spezial;E;BEâ€“3;â€“
Diskus;Fernkampf;Spezial;D;BEâ€“2;â€“
Dolche;Bewaffneter Nahkampf;Basis;D;BEâ€“1;Fechtwaffen, Raufen
Fechtwaffen;Bewaffneter Nahkampf;Spezial;E;BEâ€“1;Dolche, Schwerter
Hiebwaffen;Bewaffneter Nahkampf;Basis;D;BEâ€“4;SÃ¤bel
Infanteriewaffen;Bewaffneter Nahkampf;Spezial;D;BEâ€“3;Speere, Zweihand-Hiebwaffen
KettenstÃ¤be;Bewaffneter Nahkampf;Spezial;E;BEâ€“1;Kettenwaffen, Zweihandflegel
Kettenwaffen;Bewaffneter Nahkampf;Spezial;D;BEâ€“3;KettenstÃ¤be, Zweihandflegel
Lanzenreiten;Bewaffneter Nahkampf;Spezial;E;â€“;â€“
Peitsche;Bewaffneter Nahkampf;Spezial;E;BEâ€“1;â€“
Raufen;Waffenlos;Basis;C;BE;â€“
Ringen;Waffenlos;Basis;D;BE;â€“
SÃ¤bel;Bewaffneter Nahkampf;Basis;D;BEâ€“2;Hiebwaffen, Schwerter
Schleuder;Fernkampf;Spezial;E;BEâ€“2;â€“
Schwerter;Bewaffneter Nahkampf;Spezial;E;BEâ€“2;AnderthalbhÃ¤nder, Fechtwaffen, SÃ¤bel
Speere;Bewaffneter Nahkampf;Spezial;D;BEâ€“3;Infanteriewaffen
StÃ¤be;Bewaffneter Nahkampf;Spezial;D;BEâ€“2;Speere
Wurfbeile;Fernkampf;Spezial;D;BEâ€“2;Wurfspeere, Wurfmesser
Wurfmesser;Fernkampf;Basis;C;BEâ€“3;Wurfbeile, Wurfspeere
Wurfspeere;Fernkampf;Spezial;C;BEâ€“2;Wurfbeile
Zweihandflegel;Bewaffneter Nahkampf;Spezial;D;BEâ€“3;Infanteriewaffen, Kettenwaffen
Zweihand-Hiebwaffen;Bewaffneter Nahkampf;Spezial;D;BEâ€“3;Hiebwaffen, Infanteriewaffen
Zweihandschwerter/-sÃ¤bel;Bewaffneter Nahkampf;Spezial;E;BEâ€“2;AnderthalbhÃ¤nder, Schwerter, SÃ¤bel`;

  const zeilen = rohtext.trim().split("\n").slice(1); // Header Ã¼berspringen
  for (const zeile of zeilen) {
    const [name, kategorie, typ, steigern, ebe, ersatz] = zeile.split(";");
    const id = name.toLowerCase().replace(/\s+/g, "-").replace(/[^\w\-\/]/g, "");

    await setDoc(doc(db, "talente", id), {
      name,
      gruppe: "Kampftalente",
      typ,
      steigern,
      ebe,
      voraussetzungen: [],
      ersatzweise: ersatz === "â€“" ? [] : ersatz.split(",").map(s => s.trim()),
      eigenschaft1: null,
      eigenschaft2: null,
      eigenschaft3: null,
      kategorie
    });
  }

  alert("Import abgeschlossen!");
}

// ðŸŸ¡ Einmalig ausfÃ¼hren
// importiereKampftalente();

  </script>
</body>
</html>
