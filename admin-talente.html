<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Talente verwalten</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 1.5rem;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .container {
      max-width: 900px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 0.5rem;
      font-weight: bold;
    }

    select, input, textarea {
      padding: 0.4rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 3rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }

    .row > * {
      flex: 1 1 calc(33.333% - 1rem);
    }

    .row .full {
      flex: 1 1 100%;
    }

    button {
      margin-top: 0.6rem;
      padding: 0.6rem 1.2rem;
      background-color: #2d6cdf;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #1f4fb8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }

    th, td {
      padding: 0.6rem;
      border-bottom: 1px solid #ccc;
      text-align: left;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    th {
      background-color: #eef2f7;
    }

    td input {
      width: 80px;
      font-size: 0.9rem;
      padding: 0.3rem;
      margin: 0;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    .actions button {
      margin-right: 0.3rem;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 2rem;
      text-decoration: none;
      color: #2d6cdf;
      font-weight: bold;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .row > * {
        flex: 1 1 100%;
      }
      td input {
        width: 100%;
        margin-bottom: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Talente verwalten</h1>

    <!-- Kategorie-Auswahl -->
    <label for="kategorieSelect">Kategorie wählen:</label>
    <select id="kategorieSelect" onchange="ladeTalente()">
      <option value="Kampftalente">Kampftalente</option>
      <option value="KoerperlicheTalente">Körperliche Talente</option>
      <option value="GesellschaftlicheTalente">Gesellschaftliche Talente</option>
      <option value="Naturtalente">Natur-Talente</option>
      <option value="Wissenstalente">Wissenstalente</option>
      <option value="Handwerkstalente">Handwerkstalente</option>
    </select>

    <!-- Neues Talent hinzufügen -->
    <h2>Neues Talent hinzufügen</h2>
    <div class="row">
      <div>
        <label for="inputName">Name *</label>
        <input type="text" id="inputName" placeholder="z. B. Klettern">
      </div>
      <div>
        <label for="inputTyp">Typ *</label>
        <input type="text" id="inputTyp" placeholder="Basis / Spezial">
      </div>
      <div>
        <label for="inputSteigerung">Steigerung *</label>
        <input type="text" id="inputSteigerung" placeholder="z. B. D">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="inputEBE">eBE-Wert</label>
        <input type="text" id="inputEBE" placeholder="z. B. BE–2 oder BEx2">
      </div>
      <div>
        <label for="inputEig1">Eigenschaft 1</label>
        <input type="text" id="inputEig1" placeholder="z. B. MU">
      </div>
      <div>
        <label for="inputEig2">Eigenschaft 2</label>
        <input type="text" id="inputEig2" placeholder="z. B. GE">
      </div>
      <div>
        <label for="inputEig3">Eigenschaft 3</label>
        <input type="text" id="inputEig3" placeholder="z. B. KK">
      </div>
    </div>

    <div class="row">
      <div class="full">
        <label for="inputVoraussetzungen">Voraussetzungen</label>
        <textarea id="inputVoraussetzungen" placeholder="Komma-getrennt, z. B. „Körperbeherrschung 4, Sinnenschärfe 3“"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="full">
        <label for="inputErsatzweise">Ersatzweise Talente</label>
        <textarea id="inputErsatzweise" placeholder="Komma-getrennt, z. B. „Athletik, Akrobatik“"></textarea>
      </div>
    </div>

    <button onclick="hinzufuegenTalent()">Talent hinzufügen</button>

    <!-- Tabelle der vorhandenen Talente -->
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Typ</th>
          <th>Steigerung</th>
          <th>eBE</th>
          <th>Eigenschaften</th>
          <th>Voraussetzungen</th>
          <th>Ersatzweise</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody id="talentTabelle">
        <!-- Zeilen werden dynamisch erzeugt -->
      </tbody>
    </table>

    <a class="back-link" href="admin.html">← Zurück zum Adminbereich</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBHIftX5AvSJaPAiUIek0TBVjEtxwZo7Ow",
      authDomain: "dsapp-6722f.firebaseapp.com",
      projectId: "dsapp-6722f"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /**
     * Lädt alle Talente der aktuell ausgewählten Kategorie
     * und zeigt sie in der Tabelle an.
     */
    async function ladeTalente() {
      const kategorie = document.getElementById("kategorieSelect").value;
      const ref = collection(db, kategorie);
      const snapshot = await getDocs(ref);

      const tableBody = document.getElementById("talentTabelle");
      tableBody.innerHTML = "";

      snapshot.forEach(docSnap => {
        const id = docSnap.id;
        const data = docSnap.data();

        // Bei JSON-Struktur: data.steigerung, data.ebe, data.eigenschaft_1 etc.
        const name        = data.name || "";
        const typ         = data.typ || "";
        const steigerung  = data.steigerung || "";
        const ebe         = data.ebe || "";
        const e1          = data.eigenschaft_1 || "";
        const e2          = data.eigenschaft_2 || "";
        const e3          = data.eigenschaft_3 || "";
        const voraus      = Array.isArray(data.voraussetzungen) ? data.voraussetzungen.join(", ") : "";
        const ersatz      = Array.isArray(data.ersatzweise)     ? data.ersatzweise.join(", ")     : "";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" id="name-${id}" value="${name}"></td>
          <td><input type="text" id="typ-${id}" value="${typ}"></td>
          <td><input type="text" id="steigerung-${id}" value="${steigerung}"></td>
          <td><input type="text" id="ebe-${id}" value="${ebe}"></td>
          <td>
            <input type="text" id="e1-${id}" value="${e1}" placeholder="Eig.1">
            <input type="text" id="e2-${id}" value="${e2}" placeholder="Eig.2">
            <input type="text" id="e3-${id}" value="${e3}" placeholder="Eig.3">
          </td>
          <td><input type="text" id="voraus-${id}" value="${voraus}"></td>
          <td><input type="text" id="ersatz-${id}" value="${ersatz}"></td>
          <td class="actions">
            <button onclick="speichereTalent('${kategorie}', '${id}')">Speichern</button>
            <button onclick="loescheTalent('${kategorie}', '${id}')">Löschen</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    /**
     * Fügt ein neues Talent in die ausgewählte Kategorie ein.
     * Liest alle Felder aus, sichert in Firestore und lädt die Tabelle neu.
     */
    window.hinzufuegenTalent = async function () {
      const kategorie = document.getElementById("kategorieSelect").value;
      const name              = document.getElementById("inputName").value.trim();
      const typ               = document.getElementById("inputTyp").value.trim();
      const steigerung        = document.getElementById("inputSteigerung").value.trim();
      const ebe               = document.getElementById("inputEBE").value.trim();
      const eig1              = document.getElementById("inputEig1").value.trim();
      const eig2              = document.getElementById("inputEig2").value.trim();
      const eig3              = document.getElementById("inputEig3").value.trim();
      const voraussetzungen   = document.getElementById("inputVoraussetzungen").value
                                .split(",")
                                .map(s => s.trim())
                                .filter(Boolean);
      const ersatzweiseTalente = document.getElementById("inputErsatzweise").value
                                .split(",")
                                .map(s => s.trim())
                                .filter(Boolean);

      // Pflichtfelder prüfen
      if (!name || !typ || !steigerung) {
        alert("Bitte mindestens Name, Typ und Steigerung ausfüllen.");
        return;
      }

      // ID aus Namen generieren
      const id = name.toLowerCase().replace(/\s+/g, "-");

      await setDoc(
        doc(db, kategorie, id),
        {
          name,
          typ,
          steigerung,
          ebe,
          eigenschaft_1: eig1,
          eigenschaft_2: eig2,
          eigenschaft_3: eig3,
          voraussetzungen,
          ersatzweise: ersatzweiseTalente
        }
      );

      // Felder leeren
      document.getElementById("inputName").value = "";
      document.getElementById("inputTyp").value = "";
      document.getElementById("inputSteigerung").value = "";
      document.getElementById("inputEBE").value = "";
      document.getElementById("inputEig1").value = "";
      document.getElementById("inputEig2").value = "";
      document.getElementById("inputEig3").value = "";
      document.getElementById("inputVoraussetzungen").value = "";
      document.getElementById("inputErsatzweise").value = "";

      ladeTalente();
    };

    /**
     * Speichert Änderungen an einem existierenden Talent-Dokument.
     */
    window.speichereTalent = async function (kategorie, id) {
      const name        = document.getElementById(`name-${id}`).value.trim();
      const typ         = document.getElementById(`typ-${id}`).value.trim();
      const steigerung  = document.getElementById(`steigerung-${id}`).value.trim();
      const ebe         = document.getElementById(`ebe-${id}`).value.trim();
      const e1          = document.getElementById(`e1-${id}`).value.trim();
      const e2          = document.getElementById(`e2-${id}`).value.trim();
      const e3          = document.getElementById(`e3-${id}`).value.trim();
      const voraus      = document.getElementById(`voraus-${id}`).value
                          .split(",")
                          .map(s => s.trim())
                          .filter(Boolean);
      const ersatz      = document.getElementById(`ersatz-${id}`).value
                          .split(",")
                          .map(s => s.trim())
                          .filter(Boolean);

      if (!name || !typ || !steigerung) {
        alert("Name, Typ und Steigerung dürfen nicht leer sein.");
        return;
      }

      await updateDoc(
        doc(db, kategorie, id),
        {
          name,
          typ,
          steigerung,
          ebe,
          eigenschaft_1: e1,
          eigenschaft_2: e2,
          eigenschaft_3: e3,
          voraussetzungen: voraus,
          ersatzweise: ersatz
        }
      );

      alert("Talent gespeichert.");
      ladeTalente();
    };

    /**
     * Löscht das Talent-Dokument aus Firestore und lädt die Tabelle neu.
     */
    window.loescheTalent = async function (kategorie, id) {
      if (confirm(`Talent "${id}" wirklich löschen?`)) {
        await deleteDoc(doc(db, kategorie, id));
        ladeTalente();
      }
    };

    // Beim ersten Laden gleich die aktuell ausgewählte Kategorie anzeigen
    ladeTalente();
  </script>
</body>
</html>
