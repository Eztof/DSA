<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Talente verwalten</title>
</head>
<body>
  <h1>Talente</h1>

  <h2>Neues Talent hinzufügen</h2>
  <input id="name" placeholder="Name"><br>

  <label>Gruppe:</label>
  <select id="gruppe">
    <option>Kampftalente</option>
    <option>Körperliche Talente</option>
    <option>Gesellschaftliche Talente</option>
    <option>Natur-Talente</option>
    <option>Wissenstalente</option>
    <option>Sprachen/Schriften</option>
    <option>Handwerkstalente</option>
  </select><br>

  <div id="eigenschafts-container">
    <label>Eigenschaft 1:</label>
    <select id="eigenschaft1"></select>
    <label>Eigenschaft 2:</label>
    <select id="eigenschaft2"></select>
    <label>Eigenschaft 3:</label>
    <select id="eigenschaft3"></select><br>
  </div>

  <div id="kategorie-container" style="display: none;">
    <label>Kategorie:</label>
    <select id="kategorie">
      <option>Bewaffneter Nahkampf</option>
      <option>Fernkampf</option>
      <option>Waffenlos</option>
    </select><br>
  </div>

  <label>Typ:</label>
  <select id="typ">
    <option>Basis</option>
    <option>Spezial</option>
  </select><br>

  <textarea id="voraussetzungen" placeholder="Voraussetzungen (Komma-getrennt)"></textarea><br>

  <label>eBE-Wert:</label>
  <select id="ebe">
    <option>-</option>
    <option>BE</option>
    <option>BE–1</option>
    <option>BE–2</option>
    <option>BE–3</option>
    <option>BE–4</option>
    <option>BE–5</option>
    <option>x2</option>
  </select><br>

  <label>Steigern:</label>
  <select id="steigern">
    <option>A*</option>
    <option>A</option>
    <option>B</option>
    <option>C</option>
    <option>D</option>
    <option>E</option>
    <option>F</option>
    <option>G</option>
    <option>H</option>
  </select><br>

  <textarea id="ersatzweise" placeholder="Ersatzweise Talente mit Erschwernis (Komma-getrennt)"></textarea><br>

  <button onclick="hinzufuegen()">Hinzufügen</button>

  <h2>Vorhandene Talente</h2>
  <div id="liste"></div>

  <a href="admin.html">Zurück zum Adminbereich</a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, setDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHIftX5AvSJaPAiUIek0TBVjEtxwZo7Ow",
      authDomain: "dsapp-6722f.firebaseapp.com",
      projectId: "dsapp-6722f",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const talenteRef = collection(db, "talente");
    const eigenschaftenRef = collection(db, "eigenschaften");

    const dropdowns = ["eigenschaft1", "eigenschaft2", "eigenschaft3"];

    async function ladeEigenschaftsDropdowns() {
      const snapshot = await getDocs(eigenschaftenRef);
      const kuerzel = [];
      snapshot.forEach(doc => {
        kuerzel.push(doc.data().kuerzel);
      });

      dropdowns.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = "";
        kuerzel.forEach(k => {
          const opt = document.createElement("option");
          opt.value = k;
          opt.textContent = k;
          select.appendChild(opt);
        });
      });
    }

    document.getElementById("gruppe").addEventListener("change", () => {
      const gruppe = document.getElementById("gruppe").value;
      const isKampf = gruppe === "Kampftalente";
      document.getElementById("eigenschafts-container").style.display = isKampf ? "none" : "block";
      document.getElementById("kategorie-container").style.display = isKampf ? "block" : "none";
    });

    async function ladeTalente() {
      const container = document.getElementById("liste");
      container.innerHTML = "";

      const snapshot = await getDocs(talenteRef);
      snapshot.forEach((eintrag) => {
        const data = eintrag.data();
        const id = eintrag.id;

        const eigenschaftenText = data.gruppe === "Kampftalente"
          ? `Kategorie: ${data.kategorie}`
          : `Eigenschaften: ${data.eigenschaft1}, ${data.eigenschaft2}, ${data.eigenschaft3}`;

        const div = document.createElement("div");
        div.innerHTML = `<strong>${data.name}</strong> (${data.gruppe}) – Typ: ${data.typ}<br>
          ${eigenschaftenText}<br>
          eBE: ${data.ebe}, Steigern: ${data.steigern}<br>
          Voraussetzungen: ${data.voraussetzungen?.join(", ") || "Keine"}<br>
          Ersatzweise: ${data.ersatzweise?.join(", ") || "Keine"}<br>
          <button onclick="loescheTalent('${id}')">Löschen</button><br><br>`;
        container.appendChild(div);
      });
    }

    window.hinzufuegen = async function () {
      const name = document.getElementById("name").value.trim();
      const gruppe = document.getElementById("gruppe").value;
      const isKampf = gruppe === "Kampftalente";

      let eigenschaft1 = null, eigenschaft2 = null, eigenschaft3 = null, kategorie = null;

      if (isKampf) {
        kategorie = document.getElementById("kategorie").value;
      } else {
        eigenschaft1 = document.getElementById("eigenschaft1").value;
        eigenschaft2 = document.getElementById("eigenschaft2").value;
        eigenschaft3 = document.getElementById("eigenschaft3").value;
      }

      const typ = document.getElementById("typ").value;
      const voraussetzungen = document.getElementById("voraussetzungen").value.split(",").map(s => s.trim()).filter(Boolean);
      const ebe = document.getElementById("ebe").value;
      const steigern = document.getElementById("steigern").value;
      const ersatzweise = document.getElementById("ersatzweise").value.split(",").map(s => s.trim()).filter(Boolean);

      if (!name || !ebe || !steigern || (isKampf && !kategorie) || (!isKampf && (!eigenschaft1 || !eigenschaft2 || !eigenschaft3))) {
        alert("Bitte alle Pflichtfelder ausfüllen.");
        return;
      }

      const id = name.toLowerCase().replace(/\s+/g, "-");
      await setDoc(doc(db, "talente", id), {
        name, gruppe, typ, voraussetzungen, ebe, ersatzweise, steigern,
        eigenschaft1, eigenschaft2, eigenschaft3, kategorie
      });

      document.querySelectorAll("input, textarea").forEach(el => el.value = "");
      ladeTalente();
    };

    window.loescheTalent = async function (id) {
      if (confirm(`Talent "${id}" wirklich löschen?`)) {
        await deleteDoc(doc(db, "talente", id));
        ladeTalente();
      }
    };

    ladeEigenschaftsDropdowns().then(ladeTalente);
  </script>
</body>
</html>
